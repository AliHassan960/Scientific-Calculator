<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quantum Math Workstation V2 Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        /* --- VISUAL STYLING (Unchanged but optimized) --- */
        :root {
            --bg-grad: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
            --glass-bg: rgba(30, 41, 59, 0.85);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-main: #e2e8f0;
            --text-accent: #38bdf8;
            --text-purple: #c084fc;
            --btn-bg: rgba(255, 255, 255, 0.05);
            --btn-hover: rgba(255, 255, 255, 0.15);
            --danger: #ef4444;
            --success: #22c55e;
            --font-ui: 'Inter', sans-serif;
            --font-mono: 'Fira Code', monospace;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0; min-height: 100vh; background: var(--bg-grad);
            font-family: var(--font-ui); color: var(--text-main);
            display: flex; justify-content: center; align-items: center; padding: 20px;
        }

        .workspace {
            display: grid; grid-template-columns: 380px 450px; gap: 24px;
            max-width: 1200px; width: 100%;
        }

        .glass-panel {
            background: var(--glass-bg); backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border); border-radius: 24px;
            padding: 24px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.6);
            display: flex; flex-direction: column; gap: 16px;
        }

        .screen-container {
            background: rgba(0, 0, 0, 0.4); border-radius: 16px; padding: 20px;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.5); border: 1px solid var(--glass-border);
        }

        .status-bar { display: flex; justify-content: space-between; font-size: 0.75rem; color: #64748b; font-weight: 600; margin-bottom: 8px; }
        #mode-toggle { cursor: pointer; color: var(--text-accent); }
        .history-line { text-align: right; font-family: var(--font-mono); color: #94a3b8; font-size: 0.85rem; min-height: 1.4rem; overflow: hidden; }
        .main-display { text-align: right; font-family: var(--font-mono); font-size: 2rem; color: white; word-break: break-all; margin-top: 5px; }

        .keypad { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 5px; }
        .btn { height: 50px; border: none; border-radius: 12px; background: var(--btn-bg); color: var(--text-main); font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .btn:hover { background: var(--btn-hover); transform: translateY(-2px); }
        .btn-accent { color: var(--text-accent); }
        .btn-purple { color: var(--text-purple); font-size: 0.9rem; }
        .btn-eval { background: var(--text-accent); color: #0f172a; grid-column: span 1; box-shadow: 0 0 15px rgba(56, 189, 248, 0.3); }
        .btn-eval:hover { background: #7dd3fc; }
        .btn-del { color: var(--danger); }
        .btn-sm { font-size: 0.9rem; }

        .tabs { display: flex; gap: 8px; margin-bottom: 10px; border-bottom: 1px solid var(--glass-border); padding-bottom: 10px; flex-wrap: wrap; }
        .tab-btn { background: none; border: none; color: #94a3b8; cursor: pointer; font-weight: 600; padding: 8px 12px; border-radius: 8px; transition: 0.2s; }
        .tab-btn.active { background: var(--btn-bg); color: var(--text-accent); }
        .tab-content { display: none; height: 100%; flex-direction: column; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .base-row { display: grid; grid-template-columns: 50px 1fr; gap: 10px; margin-bottom: 15px; align-items: center; }
        .input-dark { background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); color: white; padding: 12px; border-radius: 8px; width: 100%; font-family: var(--font-mono); }
        .input-dark:focus { border-color: var(--text-accent); }

        #graph-canvas { background: #0b101a; border-radius: 12px; width: 100%; height: 300px; border: 1px solid #333; }
        .matrix-res { font-family: var(--font-mono); white-space: pre; color: var(--success); font-size: 0.85rem; margin-top: 15px; background: rgba(0,0,0,0.5); padding: 10px; border-radius: 8px; overflow-x: auto; min-height: 50px;}

        @media (max-width: 850px) { .workspace { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="workspace">
    <div class="glass-panel">
        <div class="screen-container">
            <div class="status-bar">
                <span id="mode-toggle">DEG</span>
                <span>Scientific</span>
            </div>
            <div class="history-line" id="history"></div>
            <div class="main-display" id="display">0</div>
        </div>

        <div class="keypad" id="keypad">
            <button class="btn btn-purple" data-val="func:deriv">d/dx</button>
            <button class="btn btn-purple" data-val="func:integ">∫dx</button>
            <button class="btn btn-del" data-val="AC">AC</button>
            <button class="btn btn-del" data-val="DEL">⌫</button>
            
            <button class="btn btn-sm" data-val="sin">sin</button>
            <button class="btn btn-sm" data-val="cos">cos</button>
            <button class="btn btn-sm" data-val="tan">tan</button>
            <button class="btn btn-accent" data-val="/">÷</button>

            <button class="btn btn-sm" data-val="^">x^y</button>
            <button class="btn btn-sm" data-val="sqrt">√</button>
            <button class="btn btn-sm" data-val="(">(</button>
            <button class="btn btn-sm" data-val=")">)</button>

            <button class="btn" data-val="7">7</button>
            <button class="btn" data-val="8">8</button>
            <button class="btn" data-val="9">9</button>
            <button class="btn btn-accent" data-val="*">×</button>

            <button class="btn" data-val="4">4</button>
            <button class="btn" data-val="5">5</button>
            <button class="btn" data-val="6">6</button>
            <button class="btn btn-accent" data-val="-">-</button>

            <button class="btn" data-val="1">1</button>
            <button class="btn" data-val="2">2</button>
            <button class="btn" data-val="3">3</button>
            <button class="btn btn-accent" data-val="+">+</button>

            <button class="btn" data-val="0">0</button>
            <button class="btn" data-val=".">.</button>
            <button class="btn" data-val="Ans">Ans</button>
            <button class="btn btn-eval" data-val="=">=</button>
        </div>
        <div style="font-size: 0.7rem; color:#64748b; text-align:center;">
            Examples: deriv(x^2, 3) | integ(x^2, 0, 5)
        </div>
    </div>

    <div class="glass-panel">
        <div class="tabs">
            <button class="tab-btn active" onclick="Tools.switchTab('base', event)">Base-N</button>
            <button class="tab-btn" onclick="Tools.switchTab('graph', event)">Graph</button>
            <button class="tab-btn" onclick="Tools.switchTab('matrix', event)">Matrix</button>
            <button class="tab-btn" onclick="Tools.switchTab('logs', event)">History</button>
        </div>

        <div id="tab-base" class="tab-content active">
            <h3 style="margin: 0 0 15px 0; color: var(--text-purple); font-size:1rem;">Programmer Converter</h3>
            <div class="base-row"><span style="color:#f59e0b">DEC</span><input type="number" id="base-dec" class="input-dark" placeholder="Decimal"></div>
            <div class="base-row"><span style="color:#38bdf8">HEX</span><input type="text" id="base-hex" class="input-dark" placeholder="Hexadecimal"></div>
            <div class="base-row"><span style="color:#a855f7">OCT</span><input type="number" id="base-oct" class="input-dark" placeholder="Octal"></div>
            <div class="base-row"><span style="color:#22c55e">BIN</span><input type="number" id="base-bin" class="input-dark" placeholder="Binary"></div>
        </div>

        <div id="tab-graph" class="tab-content">
            <canvas id="graph-canvas" width="400" height="300"></canvas>
            <div style="display: flex; gap:10px; margin-top:10px;">
                <input type="text" id="graph-eq" class="input-dark" value="sin(x) * x" placeholder="Function of x">
                <button class="btn btn-sm btn-accent" onclick="Graph.plot()" style="width: 80px;">Plot</button>
            </div>
        </div>

        

[Image of matrix multiplication visualization]

        <div id="tab-matrix" class="tab-content">
            <div style="display:flex; flex-direction:column; gap:10px;">
                <input type="text" id="mat-a" class="input-dark" placeholder="Matrix A (e.g. 1,2; 3,4)">
                <input type="text" id="mat-b" class="input-dark" placeholder="Matrix B (e.g. 5,6; 7,8)">
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px;">
                <button class="btn btn-sm" onclick="Matrix.calc('add')">A + B</button>
                <button class="btn btn-sm" onclick="Matrix.calc('mul')">A × B</button>
                <button class="btn btn-sm" onclick="Matrix.calc('det')">Det(A)</button>
                <button class="btn btn-sm" onclick="Matrix.calc('inv')">Inv(A)</button>
            </div>
            <div id="mat-res" class="matrix-res">Ready...</div>
        </div>

        <div id="tab-logs" class="tab-content">
            <div id="log-list" style="overflow-y: auto; flex-grow: 1; font-family: var(--font-mono); font-size: 0.9rem; color: #cbd5e1; max-height: 300px;">
                <div style="padding: 5px; opacity:0.5;">Session Log Started...</div>
            </div>
            <button class="btn btn-sm btn-del" onclick="document.getElementById('log-list').innerHTML=''" style="margin-top: 10px;">Clear Logs</button>
        </div>
    </div>
</div>

<script>
    /* --- STATE MANAGEMENT --- */
    const State = { isDegree: true, expr: '', lastAns: 0, hasError: false };
    const UI = {
        display: document.getElementById('display'),
        history: document.getElementById('history'),
        mode: document.getElementById('mode-toggle')
    };

    /* --- CALCULATOR LOGIC --- */
    const Calc = {
        input(val) {
            // Clear previous error state on new input
            if (State.hasError) {
                State.expr = ''; 
                State.hasError = false;
                UI.display.style.color = 'white';
            }

            if (val === 'AC') { State.expr = ''; UI.history.innerText = ''; }
            else if (val === 'DEL') { State.expr = State.expr.slice(0, -1); }
            else if (val === 'Ans') { State.expr += String(State.lastAns); }
            else if (val === 'func:deriv') { State.expr += 'deriv('; }
            else if (val === 'func:integ') { State.expr += 'integ('; }
            else if (val === '=') { this.evaluate(); }
            else { State.expr += val; }

            UI.display.innerText = State.expr || '0';
        },

        evaluate() {
            try {
                let raw = State.expr;
                UI.history.innerText = raw + ' =';

                // 1. Implicit Multiplication (e.g. 2x -> 2*x, 2( -> 2*()
                raw = raw.replace(/(\d)([a-z(])/gi, '$1*$2');
                raw = raw.replace(/(\))(\d)/gi, '$1*$2');

                // 2. Calculus Parsers (Improved Non-Greedy Regex)
                // Looks for deriv( ... ) but stops before the next parenthesis group if possible
                const derivRegex = /deriv\(([^,]+),([^)]+)\)/g;
                raw = raw.replace(derivRegex, (match, fn, point) => this.solveDeriv(fn, point));

                const integRegex = /integ\(([^,]+),([^,]+),([^)]+)\)/g;
                raw = raw.replace(integRegex, (match, fn, a, b) => this.solveInteg(fn, a, b));

                // 3. Math Replacements
                let parsed = raw
                    .replace(/×/g, '*')
                    .replace(/÷/g, '/')
                    .replace(/\^/g, '**')
                    .replace(/π/g, 'Math.PI')
                    .replace(/e/g, 'Math.E')
                    .replace(/sqrt/g, 'Math.sqrt');

                // 4. Trig Handling
                ['sin','cos','tan','asin','acos','atan'].forEach(fn => {
                    const regex = new RegExp(`\\b${fn}\\(`, 'g');
                    parsed = parsed.replace(regex, `Math.${fn}(`);
                });

                if (State.isDegree) {
                    // Inject degree conversion into trig functions
                    parsed = parsed.replace(/Math.(sin|cos|tan)\(([^)]+)\)/g, 
                        (m, fn, args) => `Math.${fn}((${args}) * Math.PI / 180)`);
                }

                // 5. Evaluate
                let result = eval(parsed);

                if (!isFinite(result) || isNaN(result)) throw new Error('Math Error');
                
                // Clean Result
                let final = parseFloat(result.toFixed(8));
                State.lastAns = final;
                State.expr = String(final);
                UI.display.innerText = final;
                this.log(UI.history.innerText + ' ' + final);

            } catch (err) {
                State.hasError = true;
                UI.display.innerText = "Error";
                UI.display.style.color = "#ef4444";
                console.error(err);
            }
        },

        // Calculus: Numerical Derivative
        solveDeriv(fnStr, xPoint) {
            const f = (x) => {
                // Safely replace 'x' only as a variable
                let safe = fnStr.replace(/\bx\b/g, `(${x})`).replace(/\^/g, '**');
                // Add Math. prefix
                safe = safe.replace(/(sin|cos|tan|log|exp)/g, 'Math.$1');
                return eval(safe);
            };
            const x = parseFloat(xPoint);
            const h = 0.0001;
            return (f(x + h) - f(x - h)) / (2 * h);
        },

        // Calculus: Simpson's Rule Integration
        solveInteg(fnStr, start, end) {
            const f = (x) => {
                let safe = fnStr.replace(/\bx\b/g, `(${x})`).replace(/\^/g, '**');
                safe = safe.replace(/(sin|cos|tan|log|exp)/g, 'Math.$1');
                return eval(safe);
            };
            const a = parseFloat(start);
            const b = parseFloat(end);
            const n = 100; // precision
            const h = (b - a) / n;
            let sum = f(a) + f(b);
            
            for (let i = 1; i < n; i++) {
                let x = a + i * h;
                sum += (i % 2 === 0 ? 2 : 4) * f(x);
            }
            return (h / 3) * sum;
        },

        log(msg) {
            const div = document.createElement('div');
            div.style.padding = "5px"; div.style.borderBottom="1px solid rgba(255,255,255,0.1)";
            div.innerText = msg;
            document.getElementById('log-list').prepend(div);
        }
    };

    /* --- TOOLS LOGIC --- */
    const Tools = {
        switchTab(name, e) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${name}`).classList.add('active');
            e.target.classList.add('active');
        }
    };

    // Base Converter Listeners
    ['dec','hex','oct','bin'].forEach(type => {
        document.getElementById(`base-${type}`).addEventListener('input', (e) => {
            const val = e.target.value;
            if(!val) return;
            let d = parseInt(val, type==='dec'?10 : type==='hex'?16 : type==='oct'?8 : 2);
            if(isNaN(d)) return;
            if(type !== 'dec') document.getElementById('base-dec').value = d;
            if(type !== 'hex') document.getElementById('base-hex').value = d.toString(16).toUpperCase();
            if(type !== 'oct') document.getElementById('base-oct').value = d.toString(8);
            if(type !== 'bin') document.getElementById('base-bin').value = d.toString(2);
        });
    });

    /* --- GRAPHING ENGINE --- */
    const Graph = {
        canvas: document.getElementById('graph-canvas'),
        ctx: document.getElementById('graph-canvas').getContext('2d'),
        plot() {
            const w = this.canvas.width;
            const h = this.canvas.height;
            const ctx = this.ctx;
            const eq = document.getElementById('graph-eq').value;

            // Clear
            ctx.fillStyle = "#0b101a"; ctx.fillRect(0,0,w,h);
            
            // Axes
            ctx.strokeStyle = "#333"; ctx.lineWidth = 1;
            ctx.beginPath(); ctx.moveTo(0, h/2); ctx.lineTo(w, h/2); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(w/2, 0); ctx.lineTo(w/2, h); ctx.stroke();

            // Plot
            ctx.strokeStyle = "#38bdf8"; ctx.lineWidth = 2; ctx.beginPath();
            
            const scale = 20; // pixels per unit
            let first = true;

            for (let px = 0; px < w; px++) {
                // Convert pixel X to math X
                const x = (px - w/2) / scale;
                try {
                    // Safe replacement of 'x' using boundaries \b
                    let safe = eq.replace(/\bx\b/g, `(${x})`)
                                 .replace(/\^/g, '**')
                                 .replace(/(sin|cos|tan)/g, 'Math.$1');
                    
                    const y = eval(safe);
                    const py = h/2 - (y * scale);

                    if (first) { ctx.moveTo(px, py); first = false; }
                    else { ctx.lineTo(px, py); }
                } catch(e) {}
            }
            ctx.stroke();
        }
    };

    /* --- MATRIX ENGINE --- */
    const Matrix = {
        parse(id) {
            const val = document.getElementById(id).value.trim();
            if(!val) return null;
            return val.split(';').map(r => r.split(',').map(Number));
        },
        calc(op) {
            const out = document.getElementById('mat-res');
            try {
                const A = this.parse('mat-a');
                let res = [];

                if (op === 'det' || op === 'inv') {
                    if (!A) throw new Error("Matrix A required");
                    if (A.length !== A[0].length) throw new Error("Must be square");
                    
                    if (op === 'det') {
                        if(A.length === 2) res = [[ (A[0][0]*A[1][1]) - (A[0][1]*A[1][0]) ]];
                        else if(A.length === 3) {
                             res = [[ A[0][0]*(A[1][1]*A[2][2] - A[1][2]*A[2][1]) - 
                                      A[0][1]*(A[1][0]*A[2][2] - A[1][2]*A[2][0]) + 
                                      A[0][2]*(A[1][0]*A[2][1] - A[1][1]*A[2][0]) ]];
                        } else throw new Error("Only 2x2 or 3x3 for Det");
                    }
                    if (op === 'inv') {
                        if(A.length !== 2) throw new Error("Inverse only for 2x2 in Demo");
                        const det = (A[0][0]*A[1][1]) - (A[0][1]*A[1][0]);
                        if(det === 0) throw new Error("Singular Matrix (No Inv)");
                        res = [
                            [ A[1][1]/det, -A[0][1]/det ],
                            [ -A[1][0]/det, A[0][0]/det ]
                        ];
                    }
                } else {
                    const B = this.parse('mat-b');
                    if (!A || !B) throw new Error("Matrix A & B required");

                    if (op === 'add') {
                        if(A.length !== B.length || A[0].length !== B[0].length) throw new Error("Dim Mismatch");
                        res = A.map((row, i) => row.map((val, j) => val + B[i][j]));
                    }
                    if (op === 'mul') {
                        if(A[0].length !== B.length) throw new Error("Cols A != Rows B");
                        res = new Array(A.length).fill(0).map(() => new Array(B[0].length).fill(0));
                        for (let i = 0; i < A.length; i++) {
                            for (let j = 0; j < B[0].length; j++) {
                                for (let k = 0; k < A[0].length; k++) {
                                    res[i][j] += A[i][k] * B[k][j];
                                }
                            }
                        }
                    }
                }

                // Format Output
                out.innerText = res.map(r => r.map(n => Number.isInteger(n) ? n : n.toFixed(2)).join('\t')).join('\n');
                out.style.color = "#22c55e";

            } catch (err) {
                out.innerText = err.message;
                out.style.color = "#ef4444";
            }
        }
    };

    // Event Listeners
    UI.mode.addEventListener('click', () => {
        State.isDegree = !State.isDegree;
        UI.mode.innerText = State.isDegree ? 'DEG' : 'RAD';
        UI.mode.style.color = State.isDegree ? '#38bdf8' : '#c084fc';
    });

    document.getElementById('keypad').addEventListener('click', (e) => {
        if(e.target.matches('button')) Calc.input(e.target.dataset.val);
    });

    // Init Graph
    window.onload = () => Graph.plot();
</script>
</body>
</html>